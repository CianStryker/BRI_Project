---
title: "BRI_Page"
author: "Cian Stryker"
date: "10/17/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

library(readxl)
library(reshape2)
library(plyr)
library(countrycode)
library(janitor)
library(gvlma)
library(maps)
library(png)
library(cowplot)
library(reprex)
library(ggrepel)
library(gganimate)
library(tidyverse)
```

```{r, Chinese FDI Loading, message=FALSE}
Chinese_FDI <- read_excel("raw-data/Chinese_Investment_and_Construction.xlsx", skip = 4) %>%
  clean_names()

Chinese_FDI$country <- countrycode(Chinese_FDI$country, "country.name", "country.name")
Chinese_FDI$country2 = Chinese_FDI$country

Chinese_FDI$country2 <- countrycode(Chinese_FDI$country2, "country.name", "iso2c")
```

```{r, Mapwold loading, warning=FALSE}

map.world <- map_data('world')
colnames(map.world)[colnames(map.world) == 'region'] <- 'country'
map.world$country <- countrycode(map.world$country, "country.name", "country.name")

```

```{r, First setup chunk, warning=FALSE}

#Here's my first thing I want people to see. I want to find the cumulative amount of Chinese FDI per year. So I grab what I need first in terms of variables. 

China_test <- Chinese_FDI %>%
  select("year", `quantity_in_millions`, "country")

#Not its an aggregate function to find the total amount of FDI per year and country.
  
China_test1 <- aggregate(quantity_in_millions ~ country + year, data = China_test, FUN = sum)

#Not I calculate the cumulative amount per year. I've used this function before so I'm comfortable with it. I do specify that I just want the cumulative FDI in 2019 to represent total investment, per country, from 2005 until now. 

China_test2 <- China_test1 %>%
  complete(year, nesting(country), fill = list(quantity_in_millions=0)) %>%
  arrange(year) %>%
  group_by(country) %>%
  mutate(y_cum4 = cumsum(quantity_in_millions)) %>%
  filter(year == 2019)

#Here I'm just merging my map.world data with my FDI data. Left join does exactly what I want so I use it. Maybe I could've used merge, but here I thought left_join was more appropriate. I join the two on the "country" column which is now uniform. 

workss <- left_join(map.world, China_test2, by = c("country"))
```

```{r, Commulative BRI graph by Target Region}
China_sector4 <- Chinese_FDI %>%
    select("country", "region", "year", "sector", "quantity_in_millions") %>%
    filter(sector %in% c("Energy", "Real estate", "Metals", "Transport")) %>%
    filter(region %in% c("Arab Middle East and North Africa", "East Asia", "South America", "Sub-Saharan Africa", "West Asia"))

China_sector4x <- aggregate(quantity_in_millions ~ country + year + region + sector, data = China_sector4, FUN = sum)

China_sector4y <- China_sector4x %>%
  complete(year, nesting(country, region, sector), fill = list(quantity_in_millions=0)) %>%
  arrange(year) %>%
  group_by(region, country, sector) %>%
  mutate(y_cum3 = cumsum(quantity_in_millions))

ggplot(China_sector4y, aes(x = sector, y = y_cum3, fill = region)) +
  geom_col()+
  labs(x=NULL, y=NULL, fill=NULL, title="Chinese BRI Investment per Year: {closest_state}") +
  theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 12)) +
  transition_states(year, transition_length = 2, state_length = 1) +
  enter_fade() + 
  guides(fill = FALSE) +
  ease_aes('sine-in-out')+ 
  facet_wrap(~region)

```

```{r, Map 2 Setup}

China2 <- Chinese_FDI %>% 
    select("year", `quantity_in_millions`, "country", "region", "country2") %>%
    filter(region %in% c("West Asia", 
                         "South America",
                         "Arab Middle East and North Africa",
                         "Sub-Saharan Africa",
                         "East Asia"
                          ))

China2_x <- aggregate(quantity_in_millions ~ country + year + region + country2, data = China2, FUN = sum)
```


```{r, Map 2 combination}
trial <- China2_x %>%
  complete(year, nesting(country, region), fill = list(quantity_in_millions=0)) %>%
  arrange(year) %>%
  group_by(region, country) %>%
  mutate(y_cum = cumsum(quantity_in_millions)) %>%
  filter(year == 2019)
  
  workss2 <- left_join(map.world, trial, by = c("country"))
``` 

```{r, Map 2 only Target Reion, warning=FALSE}
ggplot(workss2, aes( x = long, y = lat, group = group )) +
  geom_polygon(aes(fill = y_cum)) +
  guides(fill = guide_legend(reverse = T,)) +
  scale_fill_gradientn(colours = c('#461863','#404E88','#2A8A8C','#7FD157','#F9E53F')
                       ,values = scales::rescale(c(0,10000, 20000, 30000, 40000, 60000))
                       ,breaks = c(0,10000, 20000, 30000, 40000, 60000)
                       ) +
  labs(fill = 'Commulative FDI
in Millions'
       ,title = 'Commulative BRI Chinese Foreign Direct Investment by Country'
       ,subtitle = '2019'
       ,x = NULL
       ,y = NULL) +
  theme(text = element_text(family = 'Gill Sans', color = '#333333')
        ,plot.title = element_text(size = 18)
        ,plot.subtitle = element_text(size = 14)
        ,axis.ticks = element_blank()
        ,axis.text = element_blank()
        ,panel.grid = element_blank()
        ,plot.background = element_rect(fill = '#CCCCCC')
        ,legend.position = c(.18,.36)
        ,legend.background = element_rect(fill = '#CCCCCC')
        ,legend.key = element_blank()
        ) +
  annotate(geom = 'text'
           ,label = 'Source: Us Chamber of Commerce'
           ,x = 18, y = -55
           ,size = 3
           ,family = 'Gill Sans'
           ,color = '#333333'
           ,hjust = 'left'
           )
```

```{r, BRI per Country Scatter Graph}

trial2 <- China2_x %>%
  complete(year, nesting(country2, region), fill = list(quantity_in_millions=0)) %>%
  arrange(year) %>%
  group_by(region, country2) %>%
  mutate(y_cum = cumsum(quantity_in_millions)) 

ggplot(trial2, aes(x = country2, y = y_cum, size = y_cum, color = region)) +
  geom_point()+
  geom_text(data = subset(trial2, y_cum > 20000), aes(label = country2, hjust = 0, vjust = -1.3)) +
  labs(x= "Countries", y="Foreign Direct Investment", fill= NULL, title="Year: {closest_state}") +
  transition_states(year, transition_length = 2, state_length = 1) +
  enter_fade() + 
  ease_aes('sine-in-out') + 
  theme_bw() +
  guides(size = FALSE, color = FALSE) +
  theme(axis.text.x=element_blank()) +
  facet_wrap(~region)
```

```{r, Highest BRI Investment Countries Labelled Scatter}

trial2 <- trial %>%
  filter(year == 2019) %>%
  filter(y_cum >= 20000)

ggplot(trial2, aes(x = country, y = y_cum, color = region)) +
  geom_point()+
  geom_label_repel(aes(label = country),
                  box.padding   = 0.35, 
                  point.padding = 0.5,
                  label.size = 0,
                  segment.color = 'grey50') +
  labs(x= "Countries", y="Foreign Direct Investment", fill= NULL, title="Top BRI Investment Countries") +
  theme_bw() +
  expand_limits(y = 80000) +
  guides(color= FALSE) +
  theme(axis.text.x=element_blank()) +
  facet_wrap(~region)

```